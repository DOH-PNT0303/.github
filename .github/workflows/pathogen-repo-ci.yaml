# This workflow is intended to be called by workflows in our various pathogen
# build repos.  See workflow-templates/pathogen-repo-ci.yaml (a "starter"
# workflow) in this repo for an example of what the caller workflow looks like.
name: CI

on:
  workflow_call:
    inputs:
      build-args:
        description: >-
          Additional command-line arguments to pass to `nextstrain build` after
          the build directory (e.g. to Snakemake).
        type: string
        default: ""
        required: false

      repo:
        description: >-
          Repository name with owner (e.g. nextstrain/zika).  Defaults to the
          repository of the caller workflow.
        type: string
        default: ${{ github.repository }}
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: ${{ inputs.repo }}

      - uses: actions/setup-python@v3
        with:
          # Consider parameterizing the Python version. -trs, 1 April 2022
          python-version: "3.7"

      - run: python3 -m pip install --upgrade pip setuptools wheel
      - run: python3 -m pip install nextstrain-cli
      - run: nextstrain version
      - run: nextstrain check-setup
      - run: nextstrain update

      - name: Copy example data
        run: |
          if [[ -d example_data ]]; then
            mkdir -p data/
            cp -v example_data/* data/
          else
            echo No example data to copy.
          fi

      - run: nextstrain build --docker . ${{ inputs.build-args }}
